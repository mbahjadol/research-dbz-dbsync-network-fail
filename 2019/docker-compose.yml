# version: '2'
services:
  # ============================================================
  # üêí Zookeeper Service
  # ============================================================
  zookeeper:
    container_name: zookeeper
    image: quay.io/debezium/zookeeper:${DEBEZIUM_VERSION}
    ports:
     - 2181:2181
     - 2888:2888
     - 3888:3888

  # ============================================================
  # üîó Kafka Service
  # ============================================================
  kafka:  
    container_name: kafka
    image: quay.io/debezium/kafka:${DEBEZIUM_VERSION}
    ports:
     - 9092:9092
     - 9101:9101   # <-- Prometheus JMX metrics
    depends_on:
     - zookeeper
    environment:
     ZOOKEEPER_CONNECT: zookeeper:2181
     KAFKA_JMX_PORT: 9101
     KAFKA_JMX_OPTS: |
      -Dcom.sun.management.jmxremote=true
      -Dcom.sun.management.jmxremote.local.only=false
      -Dcom.sun.management.jmxremote.rmi.port=9101
      -Djava.rmi.server.hostname=kafka
  
  # ============================================================
  # üåê Kafka UI Service
  # ============================================================
  kafka-ui:
    container_name: kafka-ui
    image: provectuslabs/kafka-ui
    ports:
      - "8080:8080"
    environment:
      KAFKA_CLUSTERS_0_NAME: local
      KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS: kafka:9092  # Adjust if your broker name is different     

  # ============================================================
  # üì§ Kafka Exporter Service
  # ============================================================
  kafka-exporter:
    container_name: kafka-exporter
    image: danielqsj/kafka-exporter:latest
    ports:
      - "9308:9308"
    command:
      - "--kafka.server=kafka:9092"
      - "--log.level=info"
    depends_on:
      - kafka
    restart: unless-stopped

  # ============================================================
  # ‚õìÔ∏è Debezium Connect Service
  # ============================================================
  connect:
    container_name: connect
    image: quay.io/debezium/connect:${DEBEZIUM_VERSION}
    ports:
     - 8083:8083
     - 9102:9102   # <-- Prometheus JMX metrics
    depends_on:
     - kafka
     - ${SOURCE_NAME}
     - ${TARGET_NAME}
    environment:
     BOOTSTRAP_SERVERS: kafka:9092
     GROUP_ID: 1
     CONFIG_STORAGE_TOPIC: ${CONFIG_STORAGE_TOPIC}
     OFFSET_STORAGE_TOPIC: ${OFFSET_STORAGE_TOPIC}
     STATUS_STORAGE_TOPIC: ${STATUS_STORAGE_TOPIC}
     KAFKA_JMX_PORT: 9102
     KAFKA_JMX_OPTS: |
      -Dcom.sun.management.jmxremote=true
      -Dcom.sun.management.jmxremote.local.only=false
      -Dcom.sun.management.jmxremote.rmi.port=9102
      -Djava.rmi.server.hostname=connect

  # ============================================================
  # üìà Prometheus Service
  # ============================================================
  prometheus:
    container_name: prometheus
    image: prom/prometheus:latest
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
    ports:
      - "9090:9090"
    depends_on:
      - kafka
      - connect
      - kafka-exporter

  # ============================================================
  # üìä Grafana Service
  # ============================================================
  grafana:
    container_name: grafana
    image: grafana/grafana:latest
    # entrypoint: ["/bin/bash", "/grafana-init.sh"]
    volumes:
      - ./grafana/provisioning/datasources/prometheus.yml:/etc/grafana/provisioning/datasources/prometheus.yml
      - ./grafana/provisioning/dashboards/dashboard.yml:/etc/grafana/provisioning/dashboards/dashboard.yml
      - ./grafana/provisioning/dashboards_json/kafka-lag-dashboard.json:/etc/grafana/provisioning/dashboards_json/kafka-lag-dashboard.json      
      # - ./grafana/grafana-init.sh:/grafana-init.sh
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
    depends_on:
      - prometheus

  # ============================================================
  # üõ¢Ô∏è Source Database Service
  # ============================================================
  source-db:
    container_name: ${SOURCE_NAME}
    image: debezium/sql-server-keys
    build:
      context: debezium-sqlserver-init
    hostname: source-db
    ports:
     - 1433:1433
    environment:
     - ACCEPT_EULA=Y
     - MSSQL_PID=Enterprise
     - SA_USER=sa
     - SA_PASSWORD=Password!
     - MSSQL_AGENT_ENABLED=true
     - MSSQL_ENABLE_HADR=1

  # ============================================================
  # üõ¢Ô∏è Target Database Service
  # ============================================================
  target-db:
    container_name: ${TARGET_NAME}
    image: debezium/sql-server-keys
    build:
      context: debezium-sqlserver-init
    hostname: target-db
    ports:
     - 14331:1433
    environment:
     - ACCEPT_EULA=Y
     - MSSQL_PID=Enterprise
     - SA_USER=sa
     - SA_PASSWORD=Password!
     - MSSQL_AGENT_ENABLED=true
     - MSSQL_ENABLE_HADR=1

  # ============================================================
  # üß™ Simulation Service for generating workload
  # ============================================================
  sim-svc:
    container_name: sim-svc
    image: sim-svc:latest
    build: ./sim-svc
    environment:
      DB_SERVER: source-db
      DB_PORT: 1433
      DB_USER: sa
      DB_PASSWORD: Password!
      DB_NAME: inventory
      QPS_INSERT: 10
      QPS_UPDATE: 50
    ports:
      - "8000:8000"
  # ============================================================
